<!DOCTYPE html>
<html lang="en">
<!--
====================================================
    __  ____  ______________  _______ ___    __
   / / / /  |/  / ____/   \ \/ / ___//   |  / /
  / /_/ / /|_/ / /_  / /| |\  /\__ \/ /| | / /
 / __  / /  / / __/ / ___ |/ /___/ / ___ |/ /___
/_/ /_/_/  /_/_/   /_/  |_/_//____/_/  |_/_____/

====================================================
Owner Name: Hossain Mohammad Faysal
Profile: https://www.facebook.com/hmfaysal
Version: 1.1
Description: Awesome dude, awesome life
====================================================
-->
<head>
<meta charset='utf-8'>
<title>Ruby Refactoring step by step - part 1 - Woman on Rails - web development from woman perspective</title>
<meta name="description" content="How refactor your code? <br> From procedural to more object related code.">
<meta name="keywords" content="Ruby">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://womanonrails.com/images/womanonrails-square.svg">
<meta name="twitter:title" content="Ruby Refactoring step by step - part 1">
<meta name="twitter:description" content="How refactor your code? <br> From procedural to more object related code.">
<meta name="twitter:creator" content="@womanonrails">

<!-- Open Graph -->
<meta property="og:type" content="website">
<meta property="og:title" content="Ruby Refactoring step by step - part 1">
<meta property="og:description" content="How refactor your code? <br> From procedural to more object related code.">
<meta property="og:image" content="https://womanonrails.com/images/womanonrails-1000x1000.jpg">

<link rel='shortcut icon' href="https://womanonrails.com/favicon.ico">
<link rel='shortcut icon' href="https://womanonrails.com/favicon.png">





<link rel="canonical" href="https://womanonrails.com/refactoring-step-by-step">
<link href="https://womanonrails.com/feed.xml" type="application/atom+xml" rel="alternate" title="Woman on Rails Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Begin Jekyll SEO tag v2.6.0 -->
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Ruby Refactoring step by step - part 1" />
<meta name="author" content="womanonrails" />
<meta property="og:locale" content="en" />
<meta name="description" content="How refactor your code? From procedural to more object related code." />
<meta property="og:description" content="How refactor your code? From procedural to more object related code." />
<link rel="canonical" href="https://womanonrails.com/refactoring-step-by-step" />
<meta property="og:url" content="https://womanonrails.com/refactoring-step-by-step" />
<meta property="og:site_name" content="Woman on Rails" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-10-08T00:00:00-04:00" />
<script type="application/ld+json">
{"description":"How refactor your code? From procedural to more object related code.","headline":"Ruby Refactoring step by step - part 1","dateModified":"2018-10-08T00:00:00-04:00","datePublished":"2018-10-08T00:00:00-04:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://womanonrails.com/refactoring-step-by-step"},"url":"https://womanonrails.com/refactoring-step-by-step","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://womanonrails.com/womanonrails-square.svg"},"name":"womanonrails"},"author":{"@type":"Person","name":"womanonrails"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<link rel="stylesheet" type="text/css" href="https://womanonrails.com/assets/css/bootstrap.css" />
<link rel="stylesheet" type="text/css" href="https://womanonrails.com/assets/css/style.css" />
<link rel="stylesheet" href="/css/main.css">

<div class="search-wrapper">
    <div class="search-form">
        <input type="text" class="search-field" placeholder="Search...">
        <i class="icon-remove-sign"></i>
        <ul class="search-results post-list"></ul><!-- /.search-results -->
    </div><!-- /.search-form -->
</div><!-- ./search-wrapper -->

</head>
<body class="post-template" itemscope itemtype="https://schema.org/WebPage">
<div id="fade"></div>
<a id="slide" class="animated fade"></a>
<aside id="sidebar">
  <nav id="navigation">
    <h2>MENU</h2>
    <hr>
    <ul>
      
        
          <li>
            
              <a href="https://womanonrails.com/">Home</a>
            
          </li>
        
          <li>
            
              <a href="https://womanonrails.com/categories">Categories</a>
            
          </li>
        
          <li>
            
              <a href="https://womanonrails.com/tags">Tags</a>
            
          </li>
        
          <li>
            
              <a href="https://womanonrails.com/about">About</a>
            
          </li>
        
      
      <li>
        <a href="https://womanonrails.com/feed.xml" title="Atom/RSS feed">
          <i class="icon-rss"></i> Feed
        </a>
      </li>
    </ul>
    </nav>
</aside>


<header id="masthead" class="blog-background overlay align-center align-middle animated from-bottom" itemscope itemtype="https://schema.org/Organization">


    <button class="menu-button animated fade dosearch" title="Search">
        <i class="icon-search"></i>
    </button>


  
  <a href="https://womanonrails.com/pl/refactoring-step-by-step" class='language animated fade'>
    pl
  </a>


    <div class="inner">
        <div class="container">
            
            <a class="brand" href="https://womanonrails.com/" role="banner" itemprop="url">
              
<img itemprop='logo' src="https://womanonrails.com/images/womanonrails-square.svg" alt="Woman on Rails Logo" width='120' />



            <h1 class="blog-title light" itemprop="name">
                Woman on Rails
            </h1>

            </a>
            <h2 class="blog-description light bordered bordered-top" itemprop="description">
                Premature optimization is the root of all evil.
            </h2>
        </div>
    </div>
    
    
    <div class="decor-wrapper">
        <svg id="header-decor" class="decor bottom" xmlns="https://www.w3.org/2000/svg" version="1.1" viewBox="0 0 100 100" preserveAspectRatio="none">
            <path class="large left" d="M0 0 L50 50 L0 100" fill="rgba(255,255,255, .1)"></path>
            <path class="large right" d="M100 0 L50 50 L100 100" fill="rgba(255,255,255, .1)"></path>

            <path class="medium left" d="M0 100 L50 50 L0 33.3" fill="rgba(255,255,255, .3)"></path>
            <path class="medium right" d="M100 100 L50 50 L100 33.3" fill="rgba(255,255,255, .3)"></path>

            <path class="small left" d="M0 100 L50 50 L0 66.6" fill="rgba(255,255,255, .5)"></path>
            <path class="small right" d="M100 100 L50 50 L100 66.6" fill="rgba(255,255,255, .5)"></path>

            <path d="M0 99.9 L50 49.9 L100 99.9 L0 99.9" fill="rgba(255,255,255, 1)"></path>

            <path d="M48 52 L50 49 L52 52 L48 52" fill="rgba(255,255,255, 1)"></path>

        </svg>
    </div>
    
</header>

<div id="main" class="content" role="main" itemprop="mainContentOfPage" itemscope itemtype="https://schema.org/Blog">
    <div class="container">
        <div class="row">
            <article class="post col-md-8 col-md-offset-2 hentry" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
            
            
            
            
                    <header class="post-header entry-header">
                        
                        <h1 class="post-title text-center hyper lighter bordered-bottom entry-title" itemprop="headline">Ruby Refactoring step by step - part 1</h1>
                        
                        <div class="cursive" style="color: #000; font-style:italic;">How refactor your code? <br> From procedural to more object related code.</div>
                        <div class="post-info text-center small">
                            <span class="entry-date date published updated"><time datetime="2018-10-08T00:00:00-04:00" class="post-time" itemprop="datePublished">08 Oct 2018</time><span>
                            in <span class="post-tags"><a href="https://womanonrails.com/categories/index.html#refactoring" data-toggle="tooltip" title="Other posts from the Refactoring category" rel="tag">Refactoring</a></span>&nbsp;<span class="post-tags"><i class="icon-time"></i>&nbsp;<span class="time">9.575</span> minutes read</span>
                        </div>
                    </header>
                    <div class="post-body bordered-bottom" itemprop="description">
                        
                        <p>It was a long break from the last technical article. During that time I was trying many different things. You can look here: <a href="https://bemore.womanonrails.com/" title="Be more - Life style blog" target="_blank">Be More - my lifestyle blog in Polish</a>, <a href="https://www.youtube.com/channel/UCudKRFuddrf8saaxUEoo0xQ" title="Woman on Rails YouTube channel" target="_blank" rel="nofollow noopener noreferrer">Woman on Rails YouTube channel</a> and my <a href="https://vimeo.com/womanonrails" title="Woman on Rails - Vimeo channel" target="_blank" rel="nonofollow noopener noreferrer">travel Vimeo channel</a>. It was a great time to discover what I like to do and what not. But back to the topic. I prepared this article for a long time. I can say even too long. I started in 2015 and now you will see the results. Let’s get started.</p>

<p>Refactoring is one of my favorite topics. I love to clean up things in real life and also in code. I’ve worked and I’m still working on web application projects. And I look for answers on how to write good code. What are the reasons that after some time our code is messy and not readable? So day by day I learn how to refactor code in a good way based on my experience and the experience of others. Today I would like to share an example of refactoring with you.</p>

<p>I got a code which was written by a person on internship long time ago in <a href="https://fractalsoft.org/" title="Fractal Soft - Ruby on Rails web applications" target="_blank">my company</a>. The plan was to improve this code. It was mostly one class which you can see  <a href="https://github.com/womanonrails/poker/blob/55c9ae0ab921f7aa95bb7e47676d87b970a32033/lib/poker/hand.rb" title="Code before refactoring" target="_blank" rel="nofollow noopener noreferrer">here</a>. In this one class you have all rules in poker to check a hand only for cards without jokers. That code is not bad. When you know business logic (in this case poker rules), you will be able to move around this code. This code has also tests. So, this is good news. It will be easier to change something if tests cover all logic. If they don’t, we can break functionality, when we won’t be careful. The code looks more procedural than object oriented and it has some duplications. Sometimes this will be enough. When this is written once and you will not need to change this code for long time <strong>maybe</strong> you don’t need to clean it up. But if the requirements can/will change, probably your code does too. You need to decide if it is better to refactor it now or later. (I prefer refactoring now, when I still remember logic and code, then later when I need to understand it one more time.) I would like to show you how I do refactoring base on this example.</p>

<h1 id="step-1---preparing-environment-to-work">Step 1 - Preparing environment to work</h1>

<p>I updated gems which were in the project and I installed gems like Rubocop or Reek to help myself start refactoring. Those tools are helpful to see where problem in code can be. To do this, first do the overview. But those are only tools, sometimes they are right and sometimes are not. And it is easy to cheat them. But this is another topic.</p>

<h2 id="stats-based-on-metrics">Stats (based on metrics):</h2>
<ul>
  <li><strong>LOC</strong> (Line of code) - 194</li>
  <li><strong>LOT</strong> (Line of tests) - 168</li>
  <li><strong>Flog</strong> - 112.8</li>
  <li><strong>Flay</strong> - 123</li>
  <li><strong>Tests</strong> - 12 examples, 0 failures</li>
</ul>

<h1 id="step-2---start-first-clean-ups">Step 2 - Start first clean ups</h1>

<p>Base on tests without going deep into logic, I made some improvements in the code. I removed some condition and simplified this code.</p>

<p>Code before change:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">straight_flush?</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">straight?</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="n">and</span> <span class="n">flush?</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
    <span class="k">return</span> <span class="kp">true</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="kp">false</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Code after change:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">straight_flush?</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
  <span class="n">straight?</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">flush?</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>All the code you can find <a href="https://github.com/womanonrails/poker/blob/148429e4591638aef38b5b7abaab5e0198d805c0/lib/poker/hand.rb" title="Code after 2nd step of refactoring" target="_blank" rel="nofollow noopener noreferrer">here</a>. This change, in my opinion, improves readability a little bit.</p>

<p>After that all tests passed.</p>

<h1 id="step-3---understand-the-logic-and-try-to-simplify-it">Step 3 - Understand the logic and try to simplify it</h1>

<p>Now when code is more readable, I can start changing the logic to simplify it. I have tests, so each of my changes relies on tests. I took the first method. I removed it (remove all content inside). And start from the beginning. This is what I got.</p>

<p>Code before change:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">one_pair?</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
  <span class="n">tmp</span> <span class="o">=</span> <span class="n">array</span><span class="p">.</span><span class="nf">clone</span>
  <span class="n">tmp</span><span class="p">.</span><span class="nf">collect!</span><span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span> <span class="o">/</span> <span class="mi">4</span> <span class="p">}</span>

<span class="c1">#  (0..8).each do |elem|</span>
<span class="c1">#    tmp.delete(elem)</span>
<span class="c1">#  end</span>

  <span class="n">helper_array</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">13</span>

  <span class="n">tmp</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">elem</span><span class="o">|</span>
    <span class="n">helper_array</span><span class="p">[</span><span class="n">elem</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">end</span>

  <span class="n">helper_array</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

  <span class="n">helper_array</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Code after:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">one_pair?</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
  <span class="nb">hash</span> <span class="o">=</span> <span class="no">Hash</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">array</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span> <span class="nb">hash</span><span class="p">[</span><span class="n">item</span> <span class="o">/</span> <span class="mi">4</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">}</span>
  <span class="nb">hash</span><span class="p">.</span><span class="nf">values</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>I repeat that approach over and over again for all methods.</p>

<ol>
  <li>Take method and remove content</li>
  <li>Run the tests (some tests are failing), understand the logic</li>
  <li>Write new code in a simpler way</li>
  <li>Check the tests</li>
</ol>

<p>After this step you can find the code <a href="https://github.com/womanonrails/poker/blob/a0bb2f6ab99bf8d977c1b68a53774b2eef7a46ac/lib/poker/hand.rb" title="Code after 3rd step of refactoring" target="_blank" rel="nofollow noopener noreferrer">here</a>. During that step I also removed commented code, Polish comments and I added some tests, which for me, were missing.</p>

<h2 id="stats">Stats:</h2>
<ul>
  <li><strong>LOC</strong>  - 73</li>
  <li><strong>LOT</strong>  - 170</li>
  <li><strong>Flog</strong> - 76.3</li>
  <li><strong>Flay</strong> - 63</li>
  <li><strong>Tests</strong> - 12 examples, 0 failures</li>
</ul>

<h1 id="step-4---from-procedural-to-more-object-oriented-code">Step 4 - From procedural to more object oriented code</h1>

<p>I don’t know if you noticed this, but everywhere we put as argument <code class="highlighter-rouge">array</code>. And we have class, but we don’t use initializer for this class. The second thing is that in many places we use something like <code class="highlighter-rouge">array.each {|item| hash [item / 4] += 1}</code> let’s move this also for initializer and use class state instead of calculating this everywhere.</p>

<h4 id="quick-explanation">Quick explanation:</h4>
<p>I think at this point I should explain a little bit how this code works. Each card has representation as a number from 0 to 51. So number 0-3 represents 2 with all colors, 4-7 represents 3 and so on. Like in this table:</p>

<table class="table refactoring-step-by-step">
  <tbody>
    <tr>
      <td>0 </td> <td>2&spades;</td>
      <td>4 </td> <td>3&spades;</td>
      <td>8 </td> <td>4&spades;</td>
      <td>12</td> <td>5&spades;</td>
      <td>16</td> <td>6&spades;</td>
      <td>20</td> <td>7&spades;</td>
      <td>24</td> <td>8&spades;</td>
    </tr>
    <tr>
      <td>1 </td> <td>2&clubs;</td>
      <td>5 </td> <td>3&clubs;</td>
      <td>9 </td> <td>4&clubs;</td>
      <td>13</td> <td>5&clubs;</td>
      <td>17</td> <td>6&clubs;</td>
      <td>21</td> <td>7&clubs;</td>
      <td>25</td> <td>8&clubs;</td>
    </tr>
    <tr class="red-text">
      <td>2 </td> <td class="red">2&hearts;</td>
      <td>6 </td> <td class="red">3&hearts;</td>
      <td>10</td> <td class="red">4&hearts;</td>
      <td>14</td> <td class="red">5&hearts;</td>
      <td>18</td> <td class="red">6&hearts;</td>
      <td>22</td> <td class="red">7&hearts;</td>
      <td>26</td> <td class="red">8&hearts;</td>
    </tr>
    <tr class="red-text">
      <td>3 </td> <td class="red">2&diams;</td>
      <td>7 </td> <td class="red">3&diams;</td>
      <td>11</td> <td class="red">4&diams;</td>
      <td>15</td> <td class="red">5&diams;</td>
      <td>19</td> <td class="red">6&diams;</td>
      <td>23</td> <td class="red">7&diams;</td>
      <td>27</td> <td class="red">8&diams;</td>
    </tr>
  </tbody>
</table>

<p><br /></p>

<table class="table refactoring-step-by-step">
  <tbody>
    <tr>
      <td>28</td> <td>9&spades;</td>
      <td>32</td> <td>10&spades;</td>
      <td>36</td> <td>J&spades;</td>
      <td>40</td> <td>D&spades;</td>
      <td>44</td> <td>K&spades;</td>
      <td>48</td> <td>A&spades;</td>
    </tr>
    <tr>
      <td>29</td> <td>9&clubs;</td>
      <td>33</td> <td>10&clubs;</td>
      <td>37</td> <td>J&clubs;</td>
      <td>41</td> <td>D&clubs;</td>
      <td>45</td> <td>K&clubs;</td>
      <td>49</td> <td>A&clubs;</td>
    </tr>
    <tr class="red-text">
      <td>30</td> <td class="red">9&hearts;</td>
      <td>34</td> <td class="red">10&hearts;</td>
      <td>38</td> <td class="red">J&hearts;</td>
      <td>42</td> <td class="red">D&hearts;</td>
      <td>46</td> <td class="red">K&hearts;</td>
      <td>50</td> <td class="red">A&hearts;</td>
    </tr>
    <tr class="red-text">
      <td>31</td> <td class="red">9&diams;</td>
      <td>35</td> <td class="red">10&diams;</td>
      <td>39</td> <td class="red">J&diams;</td>
      <td>43</td> <td class="red">D&diams;</td>
      <td>47</td> <td class="red">K&diams;</td>
      <td>52</td> <td class="red">A&diams;</td>
    </tr>
  </tbody>
</table>

<p>So code like <code class="highlighter-rouge">array.map {|item| item / 4}</code> tells us which figure from 2 to ace is on card and code like this <code class="highlighter-rouge">array.map {|item| item % 4}</code> represents the color of a card (♠, ♣, ♥, ♦).</p>

<p>For more explanation of poker rules, please check <a href="https://en.wikipedia.org/wiki/List_of_poker_hands" title="Poker hands" target="_blank" rel="nofollow noopener noreferrer">wiki page to list all of poker hands</a>.</p>

<p>We add an initializer:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
  <span class="vi">@array</span> <span class="o">=</span> <span class="n">array</span><span class="p">.</span><span class="nf">sort</span>
  <span class="vi">@cards</span> <span class="o">=</span> <span class="vi">@array</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span> <span class="n">item</span> <span class="o">/</span> <span class="mi">4</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Example of a method before change:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">three_of_a_kind?</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
  <span class="nb">hash</span> <span class="o">=</span> <span class="no">Hash</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">array</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span> <span class="nb">hash</span><span class="p">[</span><span class="n">item</span> <span class="o">/</span> <span class="mi">4</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">}</span>
  <span class="nb">hash</span><span class="p">.</span><span class="nf">values</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>After:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">three_of_a_kind?</span>
  <span class="nb">hash</span> <span class="o">=</span> <span class="no">Hash</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="vi">@cards</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span> <span class="nb">hash</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">}</span>
  <span class="nb">hash</span><span class="p">.</span><span class="nf">values</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>We remove some of duplication and use state of the class instance to improve our code. After this step you can find the code <a href="https://github.com/womanonrails/poker/blob/83d230e969df4d27ffa5e5e34a2cf1aa43e76d90/lib/poker/hand.rb" title="Code after 4th step of refactoring" target="_blank" rel="nofollow noopener noreferrer">here</a>. Quick note - I also did small refactoring on tests. I just moved the test cases to the array to also remove duplication there.</p>

<h2 id="stats-1">Stats:</h2>
<ul>
  <li><strong>LOC</strong>  - 76</li>
  <li><strong>LOT</strong>  - 190</li>
  <li><strong>Flog</strong> - 70.9</li>
  <li><strong>Flay</strong> - 57</li>
  <li><strong>Tests</strong> - 104 examples, 0 failures</li>
</ul>

<h1 id="step-5---remove-duplication">Step 5 - Remove duplication</h1>

<p>Base on Reek metric I noticed a lot of duplication in code. So I decided to move this code to one method and use the state of the class’ instance one more time. You can find the whole step <a href="https://github.com/womanonrails/poker/blob/74c05d7480e7857d1e99d604169f6eed46279758/lib/poker/hand.rb" title="Code after 5th step of refactoring" target="_blank" rel="nofollow noopener noreferrer">here</a>. And this is a quick overview.</p>

<p>We change the initalizer:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
  <span class="vi">@array</span> <span class="o">=</span> <span class="n">array</span><span class="p">.</span><span class="nf">sort</span>
  <span class="vi">@cards</span> <span class="o">=</span> <span class="vi">@array</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span> <span class="n">item</span> <span class="o">/</span> <span class="mi">4</span> <span class="p">}</span>
  <span class="vi">@frequency</span> <span class="o">=</span> <span class="n">cards_frequency</span>
<span class="k">end</span>
</code></pre></div></div>

<p>New method <code class="highlighter-rouge">cards_frequency</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">cards_frequency</span>
  <span class="nb">hash</span> <span class="o">=</span> <span class="no">Hash</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="vi">@cards</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span> <span class="nb">hash</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">}</span>
  <span class="nb">hash</span><span class="p">.</span><span class="nf">values</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Example of a method before change:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">four_of_a_kind?</span>
  <span class="nb">hash</span> <span class="o">=</span> <span class="no">Hash</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="vi">@cards</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span> <span class="nb">hash</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">}</span>
  <span class="nb">hash</span><span class="p">.</span><span class="nf">values</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>After:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">four_of_a_kind?</span>
  <span class="vi">@frequency</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="stats-2">Stats:</h2>
<ul>
  <li><strong>LOC</strong>  - 76</li>
  <li><strong>LOT</strong>  - 190</li>
  <li><strong>Flog</strong> - 61.0</li>
  <li><strong>Flay</strong> - 0</li>
  <li><strong>Tests</strong> - 104 examples, 0 failures</li>
</ul>

<h1 id="step-6---small-public-interface">Step 6 - Small public interface</h1>

<p>When you will look at the code from <a href="https://github.com/womanonrails/poker/blob/74c05d7480e7857d1e99d604169f6eed46279758/lib/poker/hand.rb" title="Code after 5th step of refactoring" target="_blank" rel="nofollow noopener noreferrer">step 5</a>, you will notice that all methods are public. <strong>The big public interface is something hard to maintain.</strong> If you will try to replace class <code class="highlighter-rouge">Hand</code> by other class you need to prepare class with the same big interface. If something is public you can use it everywhere, what also can provide new dependencies in the code. In this case, when you look closer, you will see that even tests are checking only the method <code class="highlighter-rouge">check</code>. I decided to declare all others method as private. This change is visible <a href="https://github.com/womanonrails/poker/blob/ef117a56e3cc0fbfae9de4821ac61e5489f704fc/lib/poker/hand.rb" title="Code after 6th step of refactoring" target="_blank" rel="nofollow noopener noreferrer">here</a>.</p>

<h2 id="stats-3">Stats:</h2>
<ul>
  <li><strong>LOC</strong>  - 77</li>
  <li><strong>LOT</strong>  - 190</li>
  <li><strong>Flog</strong> - 59.9</li>
  <li><strong>Flay</strong> - 0</li>
  <li><strong>Tests</strong> - 104 examples, 0 failures</li>
</ul>

<h1 id="step-7---more-clean-ups">Step 7 - More clean ups</h1>

<p>This step is similar to step 5. I removed more duplication in code and decided to change names to be more specific. I created new method <code class="highlighter-rouge">cards_figures_and_colors</code> which prepare now two things: <code class="highlighter-rouge">figures</code> and <code class="highlighter-rouge">colors</code>. You can say now: <em>where is <strong>Single responsibility principle</strong> or that is <strong>micro optimalization</strong></em> because now I use only one loop instead 2. My intuition tells me that this is ok. But you can have a different opinion. That’s fine for me. I respect that. This is how this method looks like:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">cards_figures_and_colors</span>
  <span class="vi">@array</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span> <span class="p">[</span><span class="n">item</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">item</span> <span class="o">%</span> <span class="mi">4</span><span class="p">]</span> <span class="p">}.</span><span class="nf">transpose</span>
<span class="k">end</span>
</code></pre></div></div>

<p>and I’m open to discuss if this was a good or bad step. This change affects also our <code class="highlighter-rouge">initialize</code> method:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
  <span class="vi">@array</span> <span class="o">=</span> <span class="n">array</span><span class="p">.</span><span class="nf">sort</span>
  <span class="vi">@figures</span><span class="p">,</span> <span class="vi">@colors</span> <span class="o">=</span> <span class="n">cards_figures_and_colors</span>
  <span class="vi">@frequency</span> <span class="o">=</span> <span class="n">cards_frequency</span><span class="p">.</span><span class="nf">values</span>
<span class="k">end</span>
</code></pre></div></div>

<p>In this step I also did change in method <code class="highlighter-rouge">cards_frequency</code>. I used there <code class="highlighter-rouge">each_with_object</code> (you can find more about this method in my article <a href="https://womanonrails.com/each-with-object" title="Quick overview Ruby of each_with_object method">Quick overview - each_with_object method</a>) instead of <code class="highlighter-rouge">each</code> like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">cards_frequency</span>
  <span class="vi">@figures</span><span class="p">.</span><span class="nf">each_with_object</span><span class="p">(</span><span class="no">Hash</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="p">,</span> <span class="nb">hash</span><span class="o">|</span>
    <span class="nb">hash</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Thanks to <code class="highlighter-rouge">@colors</code> instance variable I can change <code class="highlighter-rouge">flush?</code> method from:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">flush?</span>
  <span class="n">color</span> <span class="o">=</span> <span class="vi">@array</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span> <span class="n">item</span> <span class="o">%</span> <span class="mi">4</span> <span class="p">}</span>
  <span class="n">color</span><span class="p">.</span><span class="nf">uniq</span><span class="p">.</span><span class="nf">size</span> <span class="o">==</span> <span class="mi">1</span>
<span class="k">end</span>
</code></pre></div></div>

<p>to:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">flush?</span>
  <span class="vi">@colors</span><span class="p">.</span><span class="nf">uniq</span><span class="p">.</span><span class="nf">size</span> <span class="o">==</span> <span class="mi">1</span>
<span class="k">end</span>
</code></pre></div></div>

<p>You can see all the changes <a href="https://github.com/womanonrails/poker/blob/46e12428d0d67cb90d17f417147dc936815a69e7/lib/poker/hand.rb" title="Code after 7th step of refactoring" target="_blank" rel="nofollow noopener noreferrer">here</a></p>

<h2 id="stats-4">Stats:</h2>
<ul>
  <li><strong>LOC</strong>  - 80</li>
  <li><strong>LOT</strong>  - 190</li>
  <li><strong>Flog</strong> - 64.5</li>
  <li><strong>Flay</strong> - 0</li>
  <li><strong>Tests</strong> - 104 examples, 0 failures</li>
</ul>

<h1 id="summarize">Summarize</h1>

<p>Let’s summarize what we’ve done till this point:</p>

<ul>
  <li>We used metrics to do first cleanup in the code - to start</li>
  <li>We simplified the code using tests and our understanding of logic</li>
  <li>We changed procedural code and used for that more object oriented approach</li>
  <li>We removed duplications</li>
  <li>and we created a small public interface</li>
</ul>

<p>In my next article I would like to go deeper with this refactoring and focus on:</p>

<ul>
  <li>Code which is more descriptive</li>
  <li>Metaprograming as method to write more elastic code</li>
  <li>Preparing small independent classes, then one big class</li>
  <li>Building classes as elements which are replaceable and possible to combine</li>
  <li>Explanation why I used metrics on each step and what they tell us</li>
</ul>

<p>Stay tuned! My next article will come soon! If you like this article share your thoughts with me in the comments below. Thank you so much for being here. And see you next time. Bye!</p>

<hr />

<h3 id="bibliography">Bibliography</h3>

<h4 id="books">Books</h4>
<ul>
  <li><a href="https://www.amazon.com/Refactoring-Improving-Design-Existing-Code/dp/0201485672" title="Refactoring: Improving the Design of Existing Code" target="_blank" rel="nofollow noopener noreferrer">Refactoring: Improving the Design of Existing Code - Martin Fowler</a></li>
  <li><a href="https://www.amazon.com/Clean-Code-Handbook-Software-Craftsmanship/dp/0132350882" title="Clean Code: A Handbook of Agile Software Craftsmanship" target="_blank" rel="nofollow noopener noreferrer">Clean Code: A Handbook of Agile Software Craftsmanship - Robert C. Martin</a></li>
  <li><a href="http://www.amazon.com/Design-Patterns-Ruby-Russ-Olsen/dp/0321490452" title="Design Patterns in Ruby" target="_blank" rel="nofollow noopener noreferrer">Design Patterns in Ruby - Russ Olsen</a></li>
  <li><a href="https://www.amazon.com/Test-Driven-Development-Kent-Beck/dp/0321146530" title="Test Driven Development: By Example" target="_blank" rel="nofollow noopener noreferrer">Test Driven Development: By Example - Ken Beck</a></li>
  <li><a href="https://www.amazon.com/Practical-Object-Oriented-Design-Ruby-Addison-Wesley/dp/0321721330" title="Practical Object-Oriented Design in Ruby: An Agile Primer" target="_blank" rel="nofollow noopener noreferrer">Practical Object-Oriented Design in Ruby: An Agile Primer - Sandi Metz</a></li>
  <li><a href="https://www.amazon.com/Pragmatic-Programmer-Journeyman-Master/dp/020161622X" title="The Pragmatic Programmer: From Journeyman to Master" target="_blank" rel="nofollow noopener noreferrer">The Pragmatic Programmer: From Journeyman to Master - Andrew Hund, David Thomas</a></li>
</ul>

<h4 id="presentations">Presentations</h4>
<ul>
  <li><a href="https://www.youtube.com/watch?v=8bZh5LMaSmE" title="All the Little Things by Sandi Metz" target="_blank" rel="nofollow noopener noreferrer">All the Little Things by Sandi Metz</a></li>
  <li><a href="https://www.youtube.com/watch?v=5yX6ADjyqyE" title="Fat Models with Patterns by Bryan Helmkamp" target="_blank" rel="nofollow noopener noreferrer">LA Ruby Conference 2013 Refactoring Fat Models with Patterns by Bryan Helmkamp</a></li>
  <li><a href="https://www.youtube.com/watch?v=OMPfEXIlTVE" title="Nothing is something by Sandi Metz" target="_blank" rel="nofollow noopener noreferrer">Nothing is something by Sandi Metz</a></li>
  <li><a href="https://infinum.co/the-capsized-eight/best-ruby-on-rails-refactoring-talks" title="8 best Ruby on Rails refactoring talks" target="_blank" rel="nofollow noopener noreferrer">Best Ruby on Rails refactoring talks</a></li>
</ul>

                        <br>
                    
                    
                    <div class="entry-tags text-center">

                        <i class="icon-tags"></i>&nbsp;Tagged with <a href="https://womanonrails.com/tags/index.html#Ruby" data-toggle="tooltip" title="Posts tagged with Ruby" rel="tag">Ruby</a>

                    </div>
                    
                    </div>
        </div>
                    <footer class="post-footer entry-meta">
                        <div class="post-share text-center">
    <p class="light small">
        Share this post
    </p>
    <ul class="social-mini">
        <li>
            <a href="https://twitter.com/intent/tweet?text=&quot;Ruby Refactoring step by step - part 1&quot;%20https://womanonrails.com/refactoring-step-by-step%20via%20&#64;womanonrails"
            onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" data-toggle="tooltip" title="Share on Twitter" itemprop="Twitter">
                <i class="icon-twitter"></i>
            </a>
        </li>
        <li>
            <a  href="https://www.facebook.com/sharer/sharer.php?u=https://womanonrails.com/refactoring-step-by-step"
            onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" data-toggle="tooltip" title="Share on Facebook" itemprop="Facebook">
                <i class="icon-facebook"></i>
            </a>
        </li>
        <li>
            <a href="https://plus.google.com/share?url=https://womanonrails.com/refactoring-step-by-step"
           onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;" data-toggle="tooltip" title="Share on Google plus" itemprop="GooglePlus">
                <i class="icon-google-plus"></i>
            </a>
        </li>
    </ul>
</div>
                        <div class="post-author text-center">
	        <img src="https://womanonrails.com/images/womanonrails-square.svg" alt="Agnieszka Matysek's photo" itemprop="image" class="post-avatar img-circle img-responsive"/>
	    <h4 class="bordered-bottom vcard author" itemprop="author" itemscope itemtype="https://schema.org/Person">By <span itemprop="name" class="fn"><a href="https://womanonrails.com/about" title="About Agnieszka Matysek" itemprop="url">Agnieszka Matysek</a></span></h4>
	    <p>Woman, programmer, mentor, speaker, photographer and dancer with passion.</p>
</div>

                        <div id="disqus_thread"></div><!-- /#disqus_thread -->
                    </footer>
            </article>
    </div>
</div>
<footer id="footer"  class="blog-background overlay text-center align-middle animated from-top">

    <div class="inner">
        <div class="container">

            <ul class="social-icons">
            <li>
                <a href="https://twitter.com/womanonrails" data-toggle="tooltip" title="Agnieszka Matysek on Twitter" target="_blank" rel="noopener">
                    <i class="icon-twitter"></i>
                </a>
            </li>
            <li>
                <a href="https://facebook.com/womanonrails" data-toggle="tooltip" title="Agnieszka Matysek on Facebook" target="_blank" rel="noopener">
                    <i class="icon-facebook"></i>
                </a>
            </li>
            <li>
                <a href="https://stackoverflow.com/users/2885676/womanonrails" data-toggle="tooltip" title="Agnieszka Matysek on StackExchange" target="_blank" rel="noopener">
                    <i class="icon-stackexchange"></i>
                </a>
            </li>
            <li>
                <a href="https://linkedin.com/in/womanonrails" data-toggle="tooltip" title="Agnieszka Matysek on LinkedIn" target="_blank" rel="noopener">
                    <i class="icon-linkedin"></i>
                </a>
            </li>
            <li>
                <a href="https://instagram.com/womanonrails" data-toggle="tooltip" title="Agnieszka Matysek on Instagram" target="_blank" rel="noopener">
                    <i class="icon-instagram"></i>
                </a>
            </li>
            
            <li>
                <a href="https://github.com/womanonrails" data-toggle="tooltip" title="Agnieszka Matysek on Github" target="_blank" rel="noopener">
                    <i class="icon-github"></i>
                </a>
            </li>
        </ul>
            <div>
              <a href="/about">Agnieszka Matysek</a>
              &copy; 2019
              &bull; All rights reserved.
            </div>
            <ul class="menu-items">
            
            <li>
                
                    <a href="https://womanonrails.com/"><i class="icon-home"></i></a>&nbsp;&bull;
                
            </li>
            
            <li>
                
                    <a href="https://womanonrails.com/categories">Categories</a>&nbsp;&bull;
                
            </li>
            
            <li>
                
                    <a href="https://womanonrails.com/tags">Tags</a>&nbsp;&bull;
                
            </li>
            
            <li>
                
                    <a href="https://womanonrails.com/about">About</a>&nbsp;&bull;
                
            </li>
            
            <li><a href="https://womanonrails.com/feed.xml" title="Atom/RSS feed"><i class="icon-rss"></i> Feed</a></li>
        </ul>
        </div>
    </div>
    
        <div class="decor-wrapper">
            <svg id="footer-decor" class="decor top" xmlns="https://www.w3.org/2000/svg" version="1.1" viewBox="0 0 100 100" preserveAspectRatio="none">

                <path class="large left" d="M0 0 L50 50 L0 100" fill="rgba(255,255,255, .1)"></path>
                <path class="large right" d="M100 0 L50 50 L100 100" fill="rgba(255,255,255, .1)"></path>

                <path class="medium left" d="M0 0 L50 50 L0 66.6" fill="rgba(255,255,255, .3)"></path>
                <path class="medium right" d="M100 0 L50 50 L100 66.6" fill="rgba(255,255,255, .3)"></path>

                <path class="small left" d="M0 0 L50 50 L0 33.3" fill="rgba(255,255,255, .5)"></path>
                <path class="small right" d="M100 0 L50 50 L100 33.3" fill="rgba(255,255,255, .5)"></path>

                <path d="M0 0 L50 50 L100 0 L0 0" fill="rgba(255,255,255, 1)"></path>

                <path d="M48 48 L50 51 L52 48 L48 48" fill="rgba(255,255,255, 1)"></path>

            </svg>
        </div>
    
</footer>


<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="https://womanonrails.com/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="https://womanonrails.com/assets/js/scripts.min.js"></script>
<script type="text/javascript" src="https://womanonrails.com/assets/js/waypoints.min.js"></script>
<script type="text/javascript" src="https://womanonrails.com/assets/js/script.js"></script>
<script type='text/javascript'>$(document).ready(function(){$(".time").text(function(a,b){return Math.round(parseFloat(b))})});</script>

<script type="text/javascript">

/*      Slides       */

$("a#slide").click(function(){
    $("#sidebar,body,a#slide,#fade").addClass("slide")
});

$("#fade,#header,#posts-container").click(function(){
    $("#sidebar,body,a#slide,#fade").removeClass("slide")
});

$("a#click-filter").click(function(){
    $("#slide-filter").slideToggle("medium");
    $("#slide-pages").slideOut("medium");
});

$("a#click-pages").click(function(){
    $("#slide-pages").slideToggle("medium");
    $("#slide-filter").slideOut("medium");
});

/*      End-Slides      */

</script>


<!-- Jekyll Simple Search option -->
<script>
  $(document).ready(function() {
      $('.search-field').simpleJekyllSearch({
          jsonFile : 'https://womanonrails.com/search.json',
          searchResults : '.search-results',
          template : '<li><article><a href="{url}">{title} <span class="entry-date"><time datetime="{date}">{shortdate}</time></span></a></article></li>',
          noResults: '<p>Nothing found.</p>'
        });
  });

  (function( $, window, undefined ) {

     var bs = {
          close: $(".icon-remove-sign"),
          searchform: $(".search-form"),
          canvas: $("body"),
          dothis: $('.dosearch')
      };

    bs.dothis.on('click', function() {
      $('.search-wrapper').css({ display: "block" });
      bs.searchform.toggleClass('active');
      bs.searchform.find('input').focus();
      bs.canvas.toggleClass('search-overlay');
    });

      bs.close.on('click', function() {
        $('.search-wrapper').removeAttr( 'style' );
        bs.searchform.toggleClass('active');
        bs.canvas.removeClass('search-overlay');
    });
  })( jQuery, window );
</script>


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-127731573-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-127731573-1');
</script>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'womanonrails'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</body>
</html>
